<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDA (Sistema de Alto Rendimiento)</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales */
        :root {
            /* (OPTIMIZACI√ìN M√ìVIL) Altura del encabezado reducida para dar m√°s espacio al contenido */
            --header-height-mobile: 9.5rem; 
            /* Altura de los tabs para hacer el offset de scroll */
            --tabs-height: 3rem; 
        }

        .header-content-container {
             /* Altura din√°mica para scroll en el content area */
            height: calc(100vh - var(--header-height-mobile));
            overflow-y: auto;
        }

        .tab-bar-sticky {
            /* Fija la barra de pesta√±as en m√≥vil */
            top: calc(var(--header-height-mobile) - var(--tabs-height));
        }
        
        /* (OPTIMIZACI√ìN M√ìVIL) A√±ade un degradado visual para indicar que los botones de acceso r√°pido son desplazables horizontalmente */
        .scroll-hint-container {
            position: relative;
        }
        .scroll-hint-container::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: linear-gradient(to right, rgba(31, 41, 55, 0), #1f2937 80%); /* bg-gray-800 */
            pointer-events: none;
            transition: opacity 0.3s;
        }
        /* Oculta el indicador de scroll en pantallas grandes donde no es necesario */
        @media (min-width: 640px) { /* sm breakpoint */
            .scroll-hint-container::after {
                opacity: 0;
            }
        }


        /* Ajuste de altura para escritorio */
        @media (min-width: 768px) {
            :root {
                 /* Altura del encabezado en desktop */
                --header-height-mobile: 10rem; 
            }
            .header-content-container {
                height: auto;
                overflow-y: visible;
            }
            .tab-bar-sticky {
                top: calc(var(--header-height-mobile) - var(--tabs-height));
            }

            /* Estilo espec√≠fico del contenedor redimensionable en DESKTOP */
            #general-resizable-container, #pisos-resizable-container {
                display: flex;
                flex-direction: row;
                height: 100%;
                gap: 0; /* Sin gap entre los paneles para el divisor */
            }
            .resizable-panel {
                flex-grow: 1;
                min-width: 25%; /* M√≠nimo 25% de ancho para cada panel */
                max-width: 75%; /* M√°ximo 75% de ancho para cada panel */
                transition: none !important; /* Desactivar transiciones al arrastrar */
            }
            /* Estilo para los divisores (tanto el de General como el de Pisos) */
            #resizer, #pisos-resizer {
                width: 12px; 
                cursor: ew-resize;
                background-color: #6366f1; /* Indigo-500 */
                flex-shrink: 0;
                z-index: 10;
                border-radius: 9999px; /* rounded-full */
                margin: 0 10px;
            }
            /* Capa protectora invisible durante el arrastre */
            .dragging-active iframe {
                pointer-events: none;
            }
        }
        
        /* (NUEVO) Estilos para el generador de certificados */
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-upload-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-button {
            border: 2px dashed #cbd5e1; /* border-gray-300 */
            padding: 2.5rem;
            border-radius: 0.75rem; /* rounded-lg */
            background-color: #f8fafc; /* bg-slate-50 */
            transition: all 0.2s ease-in-out;
        }
        .file-upload-wrapper:hover .file-upload-button {
            background-color: #f1f5f9; /* bg-slate-100 */
            border-color: #6366f1; /* border-indigo-500 */
        }
        
        /* (NUEVO) Estilos de impresi√≥n para el certificado */
        @media print {
            body * {
                visibility: hidden;
            }
            #certificate-print-area, #certificate-print-area * {
                visibility: visible;
            }
            #certificate-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                font-family: 'Inter', sans-serif;
                color: #000;
            }
            #certificate-print-area img {
                max-width: 100% !important;
                border-radius: 0.5rem; /* rounded-lg */
                border: 1px solid #e5e7eb; /* border-gray-200 */
            }
            #certificate-print-area .no-print {
                display: none;
            }
            /* Asegura que los colores de fondo se impriman (aunque no tenemos en este dise√±o) */
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* Utilidades visuales */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
        .external-link-button {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
            font-family: 'Inter', sans-serif; 
        }
        .external-link-button:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 12px -1px rgba(0, 0, 0, 0.1), 0 4px 8px -1px rgba(0, 0, 0, 0.06);
        }
        /* Estilos para pesta√±as */
        .tab-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
            color: #9ca3af; /* gray-400 */
        }
        .tab-button:hover, .tab-button.active {
            color: #ffffff;
            border-bottom-color: #6366f1; /* indigo-500 */
            font-weight: 600;
        }
        .tab-content {
            display: none; 
        }
        .tab-content.active {
            display: block; 
        }
        .card {
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
            /* min-height: 100%; */ /* Eliminado para permitir alturas variables */
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .iframe-container {
            /* (OPTIMIZACI√ìN M√ìVIL) Altura de iframes reducida para mejorar la visibilidad de los paneles apilados */
            height: 350px; 
            min-height: 350px; 
        }
        @media (min-width: 768px) {
            .iframe-container {
                /* Aumentar altura en desktop (MODIFICADO) */
                height: 850px; 
                min-height: 850px;
            }
        }

        /* (NUEVO) Estilos para la calculadora de precios */
        .calculator-result {
            background-color: #f8fafc; /* bg-slate-50 */
            border: 1px solid #e2e8f0; /* border-slate-200 */
            border-radius: 0.75rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
            text-align: center;
            transition: all 0.3s ease-in-out;
        }
        .calculator-result-price {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 800; /* font-extrabold */
            color: #4f46e5; /* text-indigo-600 */
            letter-spacing: -0.025em; /* tracking-tight */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        // URLs de incrustaci√≥n optimizadas
        const EMBED_URLS = {
            mapa: "https://www.google.com/maps/d/embed?mid=1FVPD7tcR-PQnrgNvFXoyqxKkwKqVpTI",
            excel: "https://docs.google.com/spreadsheets/d/1Wzr_lf_cu2xxvnUvgN_2eCncOtvH25rJk-RrdGAI7pI/edit?usp=sharing&rm=minimal",
        };
        // URLs de acceso r√°pido
        const BIZNEO_URL = "https://portalfinaer.bizneohr.com/";
        const DRIVE_URL = "https://drive.google.com/drive/u/1/folders/1kt60Ood6zXrzGr4X2HEOGFIqVjyMMZiw";
        const SAI_FINAER_URL = "https://sai.finaer.es/auth/signin?callbackUrl=%2F";
        const ADMIN_FINAER_URL = "https://admin.finaer.es/login/?next=/";
        const GMAIL_URL = "https://mail.google.com/";
        const SUBIDA_PISOS_URL = "https://docs.google.com/spreadsheets/d/1T6XXYS6wLm_Q-I0pfppXlIu8x6HijC1DXEctiilhRx0/edit?usp=sharing&rm=minimal";
        const FOTOS_PISOS_EMBED_URL = "https://drive.google.com/embeddedfolderview?id=1ytEyx1zDnhDhAxfdrO9unWhxCXVhYl_R";
        const UNWATERMARK_URL = "https://unwatermark.ai/";
        const DISCORD_URL = "https://discord.com/channels/@me";
        const WHATSAPP_URL = "https://web.whatsapp.com/";
        const SPOTIFY_WEB_URL = "https://open.spotify.com/"; 

        // (NUEVO) URL del logo de Finaer subido por el usuario
        // (MODIFICADO) Logo eliminado por petici√≥n del usuario
        // const FINAER_LOGO_URL = "uploaded:Principal-1_20250606132714.png-f98285c6-b337-43f1-b1e0-b74730d52520";

        // --- Configuraci√≥n del API de Gemini ---
        const LLM_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const apiKey = "";
        const LLM_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${LLM_MODEL}:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;
        let lastGeneratedText = '';
        let uploadedScreenshotData = null; // (NUEVO) Variable para guardar la captura de pantalla
        let lastCalculatedPriceString = null; // (NUEVO) Variable para guardar el precio calculado
        let lastCalculatedPercentageString = null; // (NUEVO) Variable para guardar el porcentaje

        // (NUEVO) Tarifas para la calculadora de precios
        const PRICING_RATES = {
            propietario: {
                vivienda: 0.045,  // 4.5%
                habitacion: 0.025, // 2.5%
                comercial: 0.055   // 5.5%
            },
            inquilino: {
                vivienda: 0.049,  // 4.9%
                habitacion: 0.025, // 2.5%
                comercial: 0.065   // 6.5%
            },
            profesional_20: { // Profesional (-20%)
                vivienda: 0.036,  // 3.6%
                habitacion: 0.02,   // 2.0%
                comercial: 0.044   // 4.4%
            },
            profesional_15: { // Profesional (-15%)
                vivienda: 0.038,  // 3.8%
                habitacion: 0.021, // 2.1%
                comercial: 0.047   // 4.7%
            }
        }; // <-- CORRECCI√ìN: Faltaba esta llave de cierre

        function switchTab(tabName) {
            // Activar bot√≥n
            document.querySelectorAll('.tab-button').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
            // Activar contenido
            document.querySelectorAll('.tab-content').forEach(content => content.classList.toggle('active', content.id === `${tabName}-content`));
            
            // Forzar scroll al inicio del contenedor de contenido (relevante para m√≥vil)
            const mainContent = document.querySelector('main');
            if (mainContent) {
                 mainContent.scrollTop = 0;
            }

            // (NUEVO) Cargar la imagen de ejemplo si vamos a la pesta√±a de certificado y no hay nada
            if (tabName === 'certificado' && !uploadedScreenshotData) {
                 const preview = document.getElementById('screenshot-preview-image');
                 if (preview && !preview.src.startsWith('data:image')) {
                     preview.src = 'https://i.imgur.com/gYf20fV.png'; // URL de la imagen de ejemplo
                 }
            }
        }
        
        function alertMessage(message, type = 'info') {
            const container = document.getElementById('alert-message-container');
            if (!container) return;
            const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
            const html = `<div class="fixed top-5 right-5 z-50 p-4 text-white ${colors[type]} rounded-lg shadow-xl animate-fade-in-down" role="alert">${message}</div>`;
            container.innerHTML = html;
            setTimeout(() => { container.innerHTML = ''; }, 3000);
        }
        
        function copySummary() {
            if (!lastGeneratedText) { alertMessage('No hay an√°lisis generado para copiar.', 'error'); return; }
            const summaryHeader = "**Resumen de la visita para HubSpot:**";
            const startIndex = lastGeneratedText.indexOf(summaryHeader);
            if (startIndex === -1) { alertMessage('No se pudo encontrar el resumen para HubSpot.', 'error'); return; }
            
            // Encuentra el texto entre el encabezado y el siguiente ** o fin de texto
            let summaryText = lastGeneratedText.substring(startIndex + summaryHeader.length).trim();
            const nextBoldIndex = summaryText.indexOf('**', 1); // Busca el siguiente doble asterisco despu√©s del inicio
            if (nextBoldIndex > -1) {
                summaryText = summaryText.substring(0, nextBoldIndex).trim();
            }
            
            const cleanText = summaryText.replace(/<br>/g, '\n');
            
            if (cleanText) {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = cleanText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    alertMessage('Resumen de HubSpot copiado al portapapeles.', 'success');
                } catch (err) {
                    // Fallback to clipboard API
                    navigator.clipboard.writeText(cleanText).then(() => {
                        alertMessage('Resumen de HubSpot copiado al portapapeles.', 'success');
                    }).catch(() => {
                        alertMessage('Error al copiar el texto.', 'error');
                    });
                }
                document.body.removeChild(tempTextArea);
            } else {
                alertMessage('El resumen de HubSpot est√° vac√≠o.', 'error');
            }
        }

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function runAnalysis() {
            const promptInput = document.getElementById('analysis-prompt');
            const resultsDiv = document.getElementById('analysis-results');
            const button = document.getElementById('generate-analysis-button');
            const userPrompt = promptInput.value.trim();

            if (!userPrompt) {
                resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Por favor, introduce una nota para analizar.</p>';
                return;
            }

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analizando...';
            resultsDiv.innerHTML = '<p class="text-gray-500 italic mt-3">Activando el an√°lisis consultivo...</p>';
            lastGeneratedText = '';

            const systemInstruction = "Eres el 'Cursor de acci√≥n', un asistente experto en venta consultiva B2B y seguimiento. **Tus tips de venta consultiva se basan en los m√°s grandes expertos de la venta B2B del mundo (como Chris Voss, Jeffrey Gitomer, Zig Ziglar, Sandler Selling, SPIN Selling y Challenger Sale).** Tu tarea es analizar una nota corta del usuario sobre una interacci√≥n o visita (especialmente en el sector inmobiliario/financiero B2B) y generar un an√°lisis estructurado y √∫til con el siguiente formato, utilizando solo texto y saltos de l√≠nea:\n\n**Resumen de la Venta Consultiva:** S√≠ntesis del estado de la oportunidad, dolor detectado y valor propuesto (usando terminolog√≠a de experto B2B).\n**Siguiente Acci√≥n:** Una sugerencia de paso pr√°ctico e inmediato (Ej: Preparar propuesta B, Llamar a Director, Programar seguimiento).\n**Borrador de Correo:** Un borrador de correo electr√≥nico breve y profesional para el seguimiento.\n**Resumen de la visita para HubSpot:** Texto conciso y directo, sin encabezados, ideal para copiar y pegar como nota de actividad en el CRM (m√°ximo 3 l√≠neas, sin formato Markdown).";

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status === 429 && i < MAX_RETRIES - 1) { await sleep(Math.pow(2, i) * 1000); continue; }
                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        lastGeneratedText = text;
                        // Mejorar el formato HTML para el resultado
                        const htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-700">$1</strong>').replace(/\n/g, '<br>');
                        resultsDiv.innerHTML = `
                            <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-left mb-4 overflow-x-auto">${htmlContent}</div>
                            <button onclick="copySummary()" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition duration-200 shadow-md w-full sm:w-auto">üìã Copiar Resumen HubSpot</button>
                        `;
                    } else {
                        resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Error: No se pudo generar el an√°lisis. Int√©ntalo de nuevo.</p>';
                    }
                    break;
                } catch (error) {
                    console.error("Analysis Error:", error);
                    if (i === MAX_RETRIES - 1) {
                        resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Error: Fall√≥ la conexi√≥n con el asistente de Gemini despu√©s de varios intentos.</p>';
                    }
                } // <!-- Cierra catch -->
            } // <!-- Cierra for loop -->
            
            button.disabled = false;
            button.innerHTML = '‚ú® Generar An√°lisis';
        } // <!-- Cierra async function runAnalysis() -->
        
        async function runMarketAnalysis() {
            const promptInput = document.getElementById('market-analysis-prompt');
            const resultsDiv = document.getElementById('market-analysis-results');
            const button = document.getElementById('generate-market-analysis-button');
            const userPrompt = promptInput.value.trim();

            if (!userPrompt) {
                resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Por favor, introduce una zona o barrio para analizar.</p>';
                return;
            }

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Investigando...';
            resultsDiv.innerHTML = '<p class="text-gray-500 italic mt-3">Consultando datos de mercado en tiempo real...</p>';

            // Search queries in Spanish and English to ensure better grounding
            const queries = [`Mercado inmobiliario ${userPrompt}`, `Real estate market trends ${userPrompt}`];

            const systemInstruction = "Eres un analista experto en el mercado inmobiliario espa√±ol. Tu tarea es proporcionar un an√°lisis conciso y actualizado de la zona proporcionada por el usuario. Basa tus respuestas en informaci√≥n reciente de la web. Estructura la respuesta de la siguiente manera:\n\n**Tendencias del Mercado:** Un p√°rrafo sobre la situaci√≥n actual (precios, demanda).\n**Precios de Alquiler (Promedio):**\n- 1 Habitaci√≥n: [Precio]\n- 2 Habitaciones: [Precio]\n- 3 Habitaciones: [Precio]\n**Perfil de la Zona:**\n- **Servicios Clave:** (Transporte, colegios, parques)\n- **Demograf√≠a:** (Tipo de residentes, ambiente)\n\nUtiliza un tono profesional y directo. Finaliza siempre listando las fuentes consultadas.";
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                tools: [{ "google_search": { queries: queries } }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(LLM_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < MAX_RETRIES - 1) { await sleep(Math.pow(2, i) * 1000); continue; }
                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const text = candidate?.content?.parts?.[0]?.text;

                    if (text) {
                        let htmlContent = text
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\n- (.*?):/g, '<br>- <strong>$1:</strong>')
                            .replace(/\n/g, '<br>');
                        
                        let sourcesHtml = '';
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(source => source.uri && source.title);
                            
                            if (sources.length > 0) {
                                sourcesHtml = '<div class="mt-4 pt-2 border-t border-gray-200"><strong class="text-sm text-gray-600">Fuentes:</strong><ul class="list-disc list-inside text-xs space-y-1">';
                                sources.forEach(source => {
                                    sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:underline">${source.title}</a></li>`;
                                });
                                sourcesHtml += '</ul></div>';
                            }
                        }
                        resultsDiv.innerHTML = `<div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-left">${htmlContent}${sourcesHtml}</div>`;
                    } else {
                        resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Error: No se pudo generar el an√°lisis de mercado.</p>';
                    }
                    break;
                } catch (error) {
                    console.error("Market Analysis Error:", error);
                    if (i === MAX_RETRIES - 1) {
                        resultsDiv.innerHTML = '<p class="text-red-600 font-semibold">Error: Fall√≥ la conexi√≥n con el asistente de Gemini despu√©s de varios intentos.</p>';
                    }
                }
            }

            button.disabled = false;
            button.innerHTML = '‚ú® Obtener An√°lisis de Mercado';
        }

        // --- (NUEVO) L√≥gica de la Calculadora de Precios ---
        function calculatePrice() {
            const monthlyRentInput = document.getElementById('precio-alquiler-mensual');
            const payerTypeSelect = document.getElementById('tipo-contratante');
            const propertyTypeSelect = document.getElementById('tipo-inmueble');
            const resultsDiv = document.getElementById('precio-resultado');
            const resultsContainer = document.getElementById('precio-resultado-container');
            const calculateButton = document.getElementById('calculate-price-button');

            if (!monthlyRentInput || !payerTypeSelect || !propertyTypeSelect || !resultsDiv || !resultsContainer) {
                console.error("Elementos de la calculadora no encontrados.");
                return;
            }

            const monthlyRent = parseFloat(monthlyRentInput.value);
            const payerType = payerTypeSelect.value;
            const propertyType = propertyTypeSelect.value;

            // Deshabilitar bot√≥n si no hay alquiler
            calculateButton.disabled = !monthlyRent || monthlyRent <= 0;

            if (!monthlyRent || monthlyRent <= 0) {
                resultsContainer.style.display = 'none';
                resultsDiv.innerHTML = '--- ‚Ç¨';
                lastCalculatedPriceString = null; // (NUEVO) Limpiar el precio guardado
                lastCalculatedPercentageString = null; // (NUEVO) Limpiar el porcentaje
                generateCertificate(); // (NUEVO) Actualizar el certificado para quitar el precio
                return;
            }

            if (!PRICING_RATES[payerType] || !PRICING_RATES[payerType][propertyType]) {
                alertMessage('Configuraci√≥n de precios no v√°lida.', 'error');
                resultsContainer.style.display = 'none';
                return;
            }

            const annualRent = monthlyRent * 12;
            const rate = PRICING_RATES[payerType][propertyType];
            const finalPrice = annualRent * rate;

            // (NUEVO) Calcular y guardar el porcentaje
            const percentage = rate * 100;
            // Formatear como porcentaje con 1 decimal
            const formattedPercentage = percentage.toLocaleString('es-ES', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }) + '%';
            lastCalculatedPercentageString = formattedPercentage;


            // Formatear como moneda (Euro)
            const formatter = new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            resultsDiv.innerHTML = formatter.format(finalPrice);
            resultsContainer.style.display = 'block';
            
            lastCalculatedPriceString = formatter.format(finalPrice); // (NUEVO) Guardar el precio formateado
            generateCertificate(); // (NUEVO) Actualizar el certificado con el nuevo precio
        }


        // --- (NUEVO) L√≥gica del Generador de Certificados ---

        function handleScreenshotUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedScreenshotData = e.target.result;
                    alertMessage('Captura de pantalla cargada.', 'success');
                    generateCertificate(); // Generar autom√°ticamente al subir
                };
                reader.readAsDataURL(file);
            } else {
                uploadedScreenshotData = null;
                alertMessage('Por favor, sube un archivo de imagen v√°lido.', 'error');
            }
        }

        function generateCertificate() {
            const previewDiv = document.getElementById('certificate-preview');
            const printButton = document.getElementById('print-certificate-button');
            const uploadHint = document.getElementById('upload-hint');

            // (NUEVO) Generar bloque de precio si existe
            let priceHtmlBlock = '';
            if (lastCalculatedPriceString && lastCalculatedPercentageString) {
                priceHtmlBlock = `
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Coste de la Garant√≠a (Pago √önico):</h3>
                        <div class="calculator-result" style="text-align: left; padding: 1rem; background-color: #f5f3ff;"> <!-- bg-indigo-50 -->
                            <span class="calculator-result-price" style="font-size: 1.75rem; line-height: 1.2;"> <!-- text-3xl -->
                                ${lastCalculatedPriceString}
                            </span>
                            <span class="block text-sm font-medium text-indigo-700 mt-1">
                                (Equivalente al ${lastCalculatedPercentageString} de la anualidad)
                            </span>
                        </div>
                    </div>
                `;
            }

            if (!uploadedScreenshotData) {
                // Si no hay imagen subida, mostramos la de ejemplo y el texto
                previewDiv.innerHTML = `
                    <div id="certificate-output" class="border border-gray-200 rounded-lg p-6 sm:p-8 max-w-3xl mx-auto bg-white shadow-lg">
                        <!-- Encabezado Corporativo (ELIMINADO POR PETICI√ìN DEL USUARIO) --><!--
                        <div class="flex justify-between items-center border-b pb-4 mb-6">
                            <h2 class="text-2xl font-bold text-indigo-700">SDA Finaer</h2>
                            <span class="text-xl font-semibold text-gray-800">Certificado de Aprobaci√≥n</span>
                        </div>
                        --><!-- Imagen de la Captura --><div class="mb-6">
                            <!-- <h3 class="text-lg font-semibold text-gray-700 mb-3">Solicitud Aprobada:</h3> (T√≠tulo opcional eliminado para look m√°s limpio) --><img id="screenshot-preview-image" src="https://i.imgur.com/gYf20fV.png" alt="Captura de pantalla de la solicitud" class="w-full rounded-lg border border-gray-200 shadow-sm">
                        </div>
                        
                        <!-- (MODIFICADO) Pasos a Seguir con Estilo Corporativo --><div>
                            <h3 class="text-xl font-bold text-gray-800 mb-5 border-b pb-3">Para proceder con la firma de la garant√≠a, necesitamos que nos facilites la siguiente informaci√≥n:</h3>
                            
                            <!-- (MODIFICADO) Lista con iconos y sin t√≠tulos --><ul class="space-y-4 text-gray-700">
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                    <span class="block text-sm">Correos electr√≥nicos y n√∫meros de m√≥viles de inquilinos y propietario (todos los propietarios).</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <span class="block text-sm">Direcci√≥n completa del inmueble, calle, portal, planta, puerta, ciudad, provincia, c√≥digo postal.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                                    <span class="block text-sm">N√∫mero de DNI y nombre completos de propietarios.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><path d="M2 12a10 10 0 0 1 20 0c0 5-3.8 8-8 8s-8-3-8-8"/><path d="M2 12h20"/><path d="M6 12c0-3 4-5 6-5s6 2 6 5"/></svg>
                                    <span class="block text-sm">IBAN para domiciliar la factura de Finaer y nombre del titular de la cuenta.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="m9 12 2 2 4-4"/></svg>
	                                <span class="block text-sm">Que me especifiques si lo quieres pagar en 2, 3 √≥ 6 cuotas sin intereses.</span>
                                </li>
                                 <li class="flex items-start gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0 text-red-600 mt-0.5"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/><path d="m15 5 4 4"/></svg>
                                    <span class="block text-sm">¬øFirma telem√°tica o presencial?</span>
                                </li>
                            </ul>
                            
                            <!-- (NUEVO) Bloque de Precio Inyectado -->
                            ${priceHtmlBlock}

                        </div>
                    </div>
                `;
                printButton.style.display = 'none'; // Ocultar bot√≥n de imprimir para el ejemplo
                uploadHint.style.display = 'block'; // Mostrar hint de subir
            } else {
                // Si S√ç hay imagen subida, la usamos
                const previewImage = document.getElementById('screenshot-preview-image');
                if (previewImage) {
                    previewImage.src = uploadedScreenshotData;
                }
                printButton.style.display = 'inline-flex'; // Mostrar bot√≥n de imprimir
                uploadHint.style.display = 'none'; // Ocultar hint
            }
        }

        function printCertificate() {
            const printContent = document.getElementById('certificate-output');
            if (!printContent) {
                alertMessage('No hay certificado que imprimir.', 'error');
                return;
            }

            // (NUEVO) Obtener la imagen.
            const previewImage = document.getElementById('screenshot-preview-image');
            const imgSrc = previewImage ? previewImage.src : ''; // Obtener el src de la imagen
            
            // (NUEVO) Lista de requisitos (m√°s robusto que parsear HTML)
            const requirements = [
                "Correos electr√≥nicos y n√∫meros de m√≥viles de inquilinos y propietario (todos los propietarios).",
                "Direcci√≥n completa del inmueble, calle, portal, planta, puerta, ciudad, provincia, c√≥digo postal.",
                "N√∫mero de DNI y nombre completos de propietarios.",
                "IBAN para domiciliar la factura de Finaer y nombre del titular de la cuenta.",
                "Que me especifiques si lo quieres pagar en 2, 3 √≥ 6 cuotas sin intereses.",
                "¬øFirma telem√°tica o presencial?"
            ];

            // (NUEVO) Generar bloque de precio para impresi√≥n si existe
            let pricePrintHtml = '';
            if (lastCalculatedPriceString && lastCalculatedPercentageString) {
                pricePrintHtml = `
                    <h3 style="font-size: 1.1rem; font-weight: 600; color: #3f3f46; margin-top: 1rem; margin-bottom: 0.5rem; border-top: 1px solid #e4e4e7; padding-top: 1rem;">Coste de la Garant√≠a (Pago √önico):</h3>
                    <div style="background-color: #fafafa; border: 1px solid #e4e4e7; border-radius: 0.375rem; padding: 1rem; text-align: center;">
                        <span style="font-size: 1.5rem; font-weight: 700; color: #dc2626; line-height: 1.2;">
                            ${lastCalculatedPriceString}
                        </span>
                        <span style="display: block; font-size: 0.9rem; font-weight: 500; color: #3f3f46; margin-top: 0.25rem;">
                            (Equivalente al ${lastCalculatedPercentageString} de la anualidad)
                        </span>
                    </div>
                `;
            }

            const newWindow = window.open('', '', 'height=800,width=800');
            newWindow.document.write('<html><head><title>Detalles de la Solicitud</title>');
            // (NUEVO) CSS Corporativo para la impresi√≥n (sin Tailwind)
            newWindow.document.write('<style>');
            newWindow.document.write(`
                @media print {
                    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    background-color: #ffffff; /* bg-white */
                    color: #18181b; /* text-zinc-900 */
                    -webkit-print-color-adjust: exact;
                }
                .page-container {
                    width: 100%;
                    max-width: 800px;
                    /* (MODIFICADO) Padding reducido para compactar */
                    margin: 0 auto; /* Sin m√°rgenes verticales para evitar p√°gina en blanco */
                    padding: 1.5rem;
                    background-color: #ffffff;
                    border-radius: 0;
                    box-shadow: none;
                    border: none;
                }
                
                /* (NUEVO) Encabezado Corporativo */
                .print-header {
                    /* (MODIFICADO) Encabezado simplificado a una barra de color */
                    display: block; /* Reseteado */
                    justify-content: normal; /* Reseteado */
                    align-items: normal; /* Reseteado */
                    border-bottom: 6px solid #dc2626; /* border-red-600, m√°s grueso */
                    /* (MODIFICADO) M√°rgenes reducidos para compactar */
                    padding-bottom: 0; /* Sin padding */
                    margin-bottom: 1rem;
                }
                .print-header .title h1 {
                    /* (MODIFICADO) Tama√±o reducido */
                    font-size: 2rem;
                    font-weight: 800;
                    color: #18181b;
                    margin: 0;
                }
                .print-header .title p {
                    /* (MODIFICADO) Tama√±o reducido */
                    font-size: 1rem;
                    color: #71717a; /* text-zinc-500 */
                    margin: 0;
                }
                /* (ELIMINADO) Estilos del logo que ya no se usa */
                /*
                .print-header .logo {
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: #dc2626; /* text-red-600 */
                }
                /* (NUEVO) Estilo para la imagen del logo en el PDF */
                .print-header .logo img {
                    width: 150px; /* Ancho fijo para el logo */
                    height: auto;
                }
                */

                /* (NUEVO) Contenido Principal */
                /* (ELIMINADO) Estilo h2 que ya no se usa */
                /*
                .print-content h2 {
                    ...
                }
                */
                /* (NUEVO) Estilo para el subt√≠tulo/introducci√≥n a la lista */
                .print-content h3 {
                    font-size: 1.1rem; /* M√°s peque√±o que el h2 anterior */
                    font-weight: 600; /* semibold */
                    color: #3f3f46; /* text-zinc-700 */
                    /* (MODIFICADO) M√°rgenes reducidos para compactar */
                    margin-top: 1rem;
                    margin-bottom: 0.5rem;
                    line-height: 1.4;
                }
                .print-content img {
                    width: 100%;
                    max-width: 100%;
                    border-radius: 0.5rem;
                    border: 1px solid #e4e4e7;
                    /* (MODIFICADO) M√°rgenes reducidos para compactar */
                    margin-bottom: 0.5rem;
                }
                
                /* (NUEVO) Lista de Requisitos Estilizada */
                .requirements-list {
                    list-style: none;
                    padding-left: 0;
                    /* (MODIFICADO) M√°rgenes reducidos para compactar */
                    margin-top: 0.5rem;
                    /* (MODIFICADO) Tama√±o reducido */
                    font-size: 0.9rem;
                }
                .requirements-list li {
                    display: flex;
                    align-items: flex-start;
                    gap: 0.75rem;
                    /* (MODIFICADO) M√°rgenes y padding reducidos para compactar */
                    margin-bottom: 0.5rem;
                    color: #3f3f46; /* text-zinc-700 */
                    padding: 0.5rem;
                    background-color: #fafafa; /* bg-zinc-50 */
                    border-radius: 0.375rem;
                    border-left: 3px solid #dc2626; /* border-red-600 */
                }
                .requirements-list li::before {
                    /* (NUEVO) Icono de check rojo */
                    content: '‚úì';
                    font-weight: 700;
                    color: #dc2626; /* text-red-600 */
                    font-size: 1rem;
                    flex-shrink: 0;
                    margin-top: 2px;
                }
                
                /* (ELIMINADO) Pie de p√°gina y sus estilos */
            `);
            newWindow.document.write('<\/style></head><body>');
            
            // (NUEVO) Escribir el HTML profesional en la nueva ventana
            newWindow.document.write(`
                <div class="page-container">
                    <div class="print-header">
                        <!-- (MODIFICADO) Logo eliminado. Esta div ahora solo act√∫a como la barra de color superior. -->
                    </div>
                    
                    <div class="print-content">
                        <!-- (MODIFICADO) T√≠tulo h2 eliminado --><img src="${imgSrc}" alt="Captura de pantalla de la solicitud aprobada">
                        
                        <!-- (MODIFICADO) T√≠tulo h2 reemplazado por h3 con el nuevo texto --><h3>Para proceder con la firma de la garant√≠a, necesitamos que nos facilites la siguiente informaci√≥n:</h3>
                        <ul class="requirements-list">
                            ${requirements.map(req => `<li>${req}</li>`).join('')}
                        </ul>
                        
                        <!-- (NUEVO) Precio Inyectado para Impresi√≥n -->
                        ${pricePrintHtml}
                    </div>
                    
                    <!-- (MODIFICADO) Pie de p√°gina eliminado -->
                </div>
            `);
            
            newWindow.document.write('</body></html>');
            
            // (MODIFICADO) Aumentamos ligeramente el timeout principal a 100ms
            // para asegurar que el DOM de la nueva ventana est√© listo.
            setTimeout(() => {
                newWindow.document.close();
                newWindow.focus();
                try {
                    newWindow.print();
                    
                    // (MODIFICADO) ESTA ES LA CORRECCI√ìN CLAVE:
                    // No cerramos la ventana inmediatamente.
                    // Esperamos 1 segundo ANTES de cerrarla.
                    // Esto da tiempo al servicio de impresi√≥n/PDF del m√≥vil (Android/iOS)
                    // a leer el contenido de la ventana antes de que se destruya.
                    setTimeout(() => {
                        newWindow.close();
                    }, 1000); // 1 segundo de espera

                } catch (e) {
                    console.error("Error al imprimir:", e);
                    // Si algo falla (ej. bloqueador de popups),
                    // cerramos la ventana para no dejarla colgada.
                    newWindow.close();
                }
            }, 100); // (MODIFICADO) 100ms en lugar de 1ms

        }

        // --- To-Do List Logic (simplificado sin Firebase por la restricci√≥n de 1 archivo) ---
        let tasks = [];

        function renderTasks() {
            const listContainer = document.getElementById('todo-list');
            if (!listContainer) return;
            listContainer.innerHTML = ''; // Clear existing list

            if (tasks.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay tareas pendientes. ¬°A√±ade una!</p>';
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item flex items-center justify-between p-3 rounded-lg transition duration-200 ${task.completed ? 'bg-gray-100' : 'bg-white border hover:bg-gray-50'}`;
                const textClass = task.completed ? 'line-through text-gray-500' : 'text-gray-800 font-medium';

                taskElement.innerHTML = `
                    <div class="flex items-center flex-grow min-w-0">
                        <input type="checkbox" ${task.completed ? 'checked' : ''} class="flex-shrink-0 h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" onchange="toggleTask(${task.id})">
                        <p class="ml-3 ${textClass} break-words min-w-0 flex-grow text-sm">${task.text}</p>
                    </div>
                    <button onclick="deleteTask(${task.id})" class="flex-shrink-0 text-gray-400 hover:text-red-500 transition duration-200 ml-2 p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                `;
                listContainer.appendChild(taskElement);
            });
        }

        function addTask() {
            const input = document.getElementById('todo-input');
            const text = input.value.trim();
            if (text) {
                tasks.push({ id: Date.now(), text: text, completed: false });
                input.value = '';
                renderTasks();
            }
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
        }

        // NUEVO: Funci√≥n para tachar/destachar paradas de la ruta
        function toggleLocationStyle(checkbox) {
            const textLabel = checkbox.nextElementSibling;
            if (textLabel && textLabel.tagName === 'LABEL') {
                textLabel.classList.toggle('line-through');
                textLabel.classList.toggle('text-gray-500');
            }
        }

        // --- Resizable Panel Logic (Generalizada) ---
        const isDesktop = () => window.innerWidth >= 768;

        function setupPanelResizing(containerId, leftPanelId, rightPanelId, resizerId) {
            const leftPanel = document.getElementById(leftPanelId);
            const rightPanel = document.getElementById(rightPanelId);
            const resizer = document.getElementById(resizerId);
            const container = document.getElementById(containerId);
            
            if (!leftPanel || !rightPanel || !resizer || !container) return;

            // Set initial 50/50 width on load for desktop
            if (isDesktop()) {
                // Se usa el 100% / 2 - el margen/padding del resizer (12px de ancho + 20px de margen = 32px) -> 12px de ancho / 2 = 6px
                leftPanel.style.width = 'calc(50% - 6px)'; 
                rightPanel.style.width = 'calc(50% - 6px)';
            }

            let isResizing = false;

            const handleMouseMove = (e) => {
                if (!isResizing || !isDesktop()) return;
                e.preventDefault(); 
                const containerRect = container.getBoundingClientRect();
                const totalWidth = containerRect.width;
                let newLeftWidthPx = e.clientX - containerRect.left;
                const minWidth = totalWidth * 0.25;
                const maxWidth = totalWidth * 0.75;
                newLeftWidthPx = Math.max(minWidth, Math.min(maxWidth, newLeftWidthPx));
                const newLeftWidthPercent = (newLeftWidthPx / totalWidth) * 100;
                leftPanel.style.width = `${newLeftWidthPercent}%`;
                rightPanel.style.width = `${100 - newLeftWidthPercent}%`;
            };

            const handleMouseUp = () => {
                if (isResizing) {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                    document.body.classList.remove('dragging-active');
                }
            };

            const handleMouseDown = (e) => {
                if (!isDesktop()) return;
                isResizing = true;
                e.preventDefault(); 
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.body.classList.add('dragging-active');
            };

            resizer.addEventListener('mousedown', handleMouseDown);
        }

        // --- Generador de Ruta Comercial ---
        function generateRoute(mode) {
            const locationsInput = document.getElementById('locations-list');
            const resultsDiv = document.getElementById('route-results');
            if (!locationsInput || !resultsDiv) return;

            const locations = locationsInput.value.trim().split('\n').filter(loc => loc.trim() !== '');

            if (locations.length < 2) {
                alertMessage('Por favor, introduce al menos dos direcciones.', 'error');
                return;
            }

            // La URL base para Google Maps Directions
            let baseUrl = 'https://www.google.com/maps/dir/';
            const encodedLocations = locations.map(loc => encodeURIComponent(loc.trim()));
            baseUrl += encodedLocations.join('/');

            // A√±adir par√°metro de modo de viaje
            const travelMode = mode === 'w' ? 'w' : 'r'; // 'w' para caminar, 'r' para transporte p√∫blico
            baseUrl += `?dirflg=${travelMode}`;

            // NUEVO: Generar listado de inmobiliarias INTERACTIVO para mostrar
            let locationsListHtml = '<h3 class="font-semibold text-gray-800 mt-4 mb-2 text-left">Paradas en esta ruta:</h3><ul class="text-left text-sm space-y-2">';
            locations.forEach((loc, index) => {
                locationsListHtml += `
                    <li class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 transition-colors duration-150">
                        <input id="loc-${index}" type="checkbox" onchange="toggleLocationStyle(this)" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer flex-shrink-0">
                        <label for="loc-${index}" class="text-gray-800 cursor-pointer">${loc.trim()}</label>
                    </li>
                `;
            });
            locationsListHtml += '</ul>';

            // Mostrar el resultado
            const modeText = mode === 'w' ? 'a Pie' : 'en Transporte P√∫blico';
            resultsDiv.innerHTML = `
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center animate-fade-in-down">
                    <p class="font-semibold text-green-800">¬°Ruta optimizada lista!</p>
                    <p class="text-sm text-green-700 mb-3">Haz clic en el bot√≥n para abrir la ruta en Google Maps.</p>
                    <a href="${baseUrl}" target="_blank" class="inline-block px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                        Abrir Ruta ${modeText}
                    </a>
                    ${locationsListHtml}
                </div>
            `;
            alertMessage('Ruta generada con √©xito.', 'success');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const iframes = {
                'mapa-iframe': EMBED_URLS.mapa,
                'excel-iframe': EMBED_URLS.excel,
                'subida-pisos-iframe': SUBIDA_PISOS_URL,
                'fotos-pisos-iframe': FOTOS_PISOS_EMBED_URL
            };
            for (const [id, url] of Object.entries(iframes)) {
                const iframe = document.getElementById(id);
                if (iframe && !iframe.src.includes(url.substring(0, 20))) { 
                    iframe.src = url; 
                }
            }
            
            setupPanelResizing('general-resizable-container', 'map-panel', 'excel-panel', 'resizer');
            setupPanelResizing('pisos-resizable-container', 'subida-pisos-panel', 'fotos-pisos-panel', 'pisos-resizer');

            switchTab('general');
            
            // (NUEVO) Event Listeners para el generador de certificados
            const screenshotInput = document.getElementById('screenshot-upload');
            if (screenshotInput) {
                screenshotInput.addEventListener('change', handleScreenshotUpload);
            }
            const printButton = document.getElementById('print-certificate-button');
            if (printButton) {
                printButton.addEventListener('click', printCertificate);
            }
            // (NUEVO) Generar la vista de ejemplo al cargar
            generateCertificate();

            // (NUEVO) Event Listeners para la calculadora de precios
            const monthlyRentInput = document.getElementById('precio-alquiler-mensual');
            const payerTypeSelect = document.getElementById('tipo-contratante');
            const propertyTypeSelect = document.getElementById('tipo-inmueble');
            const calculateButton = document.getElementById('calculate-price-button');

            if (monthlyRentInput && payerTypeSelect && propertyTypeSelect && calculateButton) {
                // Calcular al cambiar cualquier valor
                monthlyRentInput.addEventListener('input', calculatePrice);
                payerTypeSelect.addEventListener('change', calculatePrice);
                propertyTypeSelect.addEventListener('change', calculatePrice);
                // Tambi√©n al hacer clic en el bot√≥n (aunque se actualiza en vivo)
                calculateButton.addEventListener('click', calculatePrice);
                // Calcular al cargar por si hay valores por defecto (aunque no los hay)
                calculatePrice();
            }


            document.getElementById('add-todo-button').addEventListener('click', addTask);
            document.getElementById('todo-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTask();
                }
            });
            renderTasks();
        });
    </script>
</head>
<body class="bg-gray-100 font-sans">
    
    <div id="alert-message-container" class="z-50"></div>

    <div class="fixed inset-0 flex flex-col">
        <!-- HEADER COMPACTO Y FIJO --><header class="bg-gray-800 text-white shadow-lg z-20 flex-shrink-0" style="height: var(--header-height-mobile);">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-4 pb-0">
                <!-- (OPTIMIZACI√ìN M√ìVIL) Margen inferior reducido --><h1 class="text-xl sm:text-3xl font-extrabold tracking-tight text-white mb-1 sm:mb-2">
                    SDA <span class="text-indigo-400">Alto Rendimiento</span>
                </h1>
                
                <!-- (OPTIMIZACI√ìN M√ìVIL) Contenedor con pista visual de scroll --><div class="flex overflow-x-auto gap-2 sm:gap-3 pb-3 -mx-4 px-4 sm:mx-0 sm:px-0 border-b border-gray-700 scroll-hint-container">
                    <!-- (OPTIMIZACI√ìN M√ìVIL) Padding de botones reducido para un look m√°s compacto --><button onclick="window.open(SAI_FINAER_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white bg-red-600 hover:bg-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/><path d="M10 10h4"/></svg>
                        SAI Finaer
                    </button>
                    <button onclick="window.open(ADMIN_FINAER_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white bg-gray-600 hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M12 15a4 4 0 0 0 4-4V2H8v9a4 4 0 0 0 4 4Z"/><path d="M17 19H7"/><path d="M20 19H4"/><path d="M12 15v4"/></svg>
                        Admin Finaer
                    </button>
                    <button onclick="window.open(GMAIL_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white bg-yellow-500 hover:bg-yellow-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.83 1.83 0 0 1-2.06 0L2 7"/></svg>
                        Gmail
                    </button>
                    <button onclick="window.open(BIZNEO_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                        Bizneo
                    </button>
                    <button onclick="window.open(DRIVE_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white bg-green-500 hover:bg-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M15.2 3.3a1 1 0 0 0-.6-.3H5.7a1 1 0 0 0-.7.3L3 5.4V19a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V5.4l-1.5-2.1Z"/><path d="M3 5.4c0-.3.06-.5.2-.7L4.7 3c.2-.2.5-.3.8-.3h8c.3 0 .5.1.7.3l1.5 2.1c.1.2.2.4.2.7"/><path d="M12 17h.01"/><path d="M10 13h4"/></svg>
                        Drive
                    </button>
                    <button onclick="window.open(WHATSAPP_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white" style="background-color: #25D366;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        WA
                    </button>
                    <button onclick="window.open(DISCORD_URL, '_blank')" class="external-link-button flex-shrink-0 flex items-center px-2.5 py-1 text-xs sm:text-sm font-semibold rounded-lg text-white" style="background-color: #5865F2;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><circle cx="12" cy="12" r="10"/><path d="M14 9H9.5M9.5 14H14.5M10 16s1.5-2 4.5-2"/></svg>
                        Discord
                    </button>
                </div>
            </div>
            
            <!-- Navegaci√≥n de Pesta√±as FIJA (Sticky) --><div class="sticky tab-bar-sticky z-30 bg-gray-800 shadow-md">
                 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex space-x-4 overflow-x-auto whitespace-nowrap pb-2">
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="general" onclick="switchTab('general')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>General</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="mercado" onclick="switchTab('mercado')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>Mercado</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="cursor" onclick="switchTab('cursor')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3z"/><path d="M15 3v6h6"/><path d="m12 18-3-3 3-3"/><path d="m15 15-3 3 3 3"/></svg>Cursor</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="incentivos" onclick="switchTab('incentivos')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>Incentivos</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="pisos" onclick="switchTab('pisos')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M15 21v-8l-4 4-4-4v8"/></svg>Pisos</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="spotify" onclick="switchTab('spotify')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>Spotify</button>
                        <!-- (NUEVO) Bot√≥n de Pesta√±a Certificado --><button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="certificado" onclick="switchTab('certificado')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m10.5 17-2-2 2-2"/><path d="m13.5 17 2-2-2-2"/></svg>Certificado</button>
                        <button class="tab-button flex items-center gap-1 py-2 px-1 text-sm" data-tab="todo" onclick="switchTab('todo')"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>Tareas</button>
                    </div>
                 </div>
            </div>
        </header>

        <!-- (OPTIMIZACI√ìN M√ìVIL) Padding reducido en el contenedor principal para pantallas peque√±as --><main class="flex-grow overflow-y-auto p-3 sm:p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Contenido Pesta√±a 1: Vista General (Redimensionable en desktop) --><div id="general-content" class="tab-content">
                <!-- En m√≥vil es una cuadr√≠cula apilada (grid grid-cols-1), en desktop es un contenedor flex redimensionable (md:flex) --><div id="general-resizable-container" class="grid grid-cols-1 gap-6 md:gap-0 min-h-full">
                    
                    <!-- Mapa Interactivo (Panel Izquierdo) --><div id="map-panel" class="card p-4 flex flex-col resizable-panel md:mr-3 min-h-full">
                        <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2 border-b pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>Mapa Interactivo de Zonas</h2>
                        <div class="iframe-container flex-grow w-full">
                            <iframe id="mapa-iframe" class="w-full h-full rounded-lg border border-gray-200" title="Mapa Interactivo" loading="lazy" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                    
                    <!-- Divisor (Solo visible y funcional en desktop) --><div id="resizer" class="hidden md:block"></div>

                    <!-- Seguimiento Comercial (Panel Derecho) --><div id="excel-panel" class="card p-4 flex flex-col resizable-panel md:ml-3 min-h-full">
                        <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2 border-b pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>Seguimiento Comercial</h2>
                        <div class="iframe-container flex-grow w-full">
                            <iframe id="excel-iframe" class="w-full h-full rounded-lg border border-gray-200" title="Seguimiento Comercial" loading="lazy" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>

                <!-- NUEVO: Generador de Ruta Comercial --><div class="card p-6 w-full mt-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M18 6.1a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1Z"/><path d="M12 21v-4"/><path d="M12 9v-2"/><path d="M12 15v-2"/></svg>
                        Generador de Ruta Comercial
                    </h2>
                    <p class="mb-4 text-gray-600 text-sm">Introduce una lista de direcciones (una por l√≠nea) para generar una ruta optimizada en Google Maps.</p>
                    <textarea id="locations-list" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Ejemplo:&#10;Inmobiliaria Finaer, Calle Goya 10, Madrid&#10;Tecnocasa, Calle Serrano 50, Madrid&#10;Redpiso, Paseo de la Castellana 100, Madrid"></textarea>
                    <div class="mt-4 flex flex-col sm:flex-row gap-3">
                        <button onclick="generateRoute('w')" class="w-full sm:w-1/2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2">
                            üö∂ Generar Ruta a Pie
                        </button>
                        <button onclick="generateRoute('r')" class="w-full sm:w-1/2 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-200 flex items-center justify-center gap-2">
                            üöá Generar Ruta en Transporte P√∫blico
                        </button>
                    </div>
                    <div id="route-results" class="mt-6"></div>
                </div>

            </div>

            <!-- Contenido Pesta√±a: An√°lisis de Mercado --><div id="mercado-content" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto w-full">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                        An√°lisis de Mercado <span class="font-normal text-gray-500 text-base hidden sm:inline">(B√∫squeda en tiempo real)</span>
                    </h2>
                    <p class="mb-4 text-gray-600">Obt√©n un informe conciso y actualizado del mercado inmobiliario para cualquier zona, barrio o ciudad de Espa√±a.</p>
                    <input type="text" id="market-analysis-prompt" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Ej: Barrio de Salamanca, Madrid">
                    <button id="generate-market-analysis-button" onclick="runMarketAnalysis()" class="mt-4 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚ú® Obtener An√°lisis de Mercado
                    </button>
                    <div id="market-analysis-results" class="mt-6 text-sm text-gray-800">
                        <p class="text-gray-500">El informe de mercado aparecer√° aqu√≠.</p>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Cursor de Acci√≥n --><div id="cursor-content" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto w-full">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M15.5 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.5L15.5 3z"/><path d="M15 3v6h6"/><path d="m12 18-3-3 3-3"/><path d="m15 15-3 3 3 3"/></svg>
                        Cursor de acci√≥n <span class="font-normal text-gray-500 text-base hidden sm:inline">(Asistente Consultivo IA)</span>
                    </h2>
                    <p class="mb-4 text-gray-600 text-sm">Analiza notas de interacciones para obtener un resumen de venta B2B, la siguiente acci√≥n y un borrador de correo, optimizado para el CRM (HubSpot).</p>
                    <textarea id="analysis-prompt" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                              placeholder="Ej: Visita con Inmobiliaria √âlite. El director (Juan) confirm√≥ que su dolor es la lenta aprobaci√≥n de hipotecas y le propuse nuestra soluci√≥n 24h. Presupuesto ok, enviar propuesta ma√±ana."></textarea>
                    <button id="generate-analysis-button" onclick="runAnalysis()"
                            class="mt-4 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚ú® Generar An√°lisis
                    </button>
                    <div id="analysis-results" class="mt-6 text-sm text-gray-800">
                        <p class="text-gray-500">El resultado del an√°lisis aparecer√° aqu√≠.</p>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Incentivos --><div id="incentivos-content" class="tab-content">
                <div class="card p-6 w-full">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-6 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>Tabla de Incentivos FIVY PRO</h2>
                    <!-- Tabla de Incentivos con scroll horizontal para m√≥vil --><div class="overflow-x-auto shadow-lg rounded-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider sticky left-0 bg-gray-50 z-10" rowspan="2">Zonas</th>
                                    <th scope="col" colspan="3" class="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider border-b border-l">Renta Vivienda (‚Ç¨)</th>
                                    <th scope="col" colspan="3" class="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider border-b border-l">Renta Habitaci√≥n (‚Ç¨)</th>
                                </tr>
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider border-l">500 - 1500 ‚Ç¨</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">1501 - 2500 ‚Ç¨</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">+ 2500 ‚Ç¨</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider border-l">100 - 500 ‚Ç¨</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">501 - 1000 ‚Ç¨</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">+ 1000 ‚Ç¨</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200 text-sm">
                                <tr>
                                    <td class="px-3 py-4 whitespace-nowrap font-bold text-indigo-700 sticky left-0 bg-white z-10">Zona 1</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">25‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">30‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">35‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">12‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">15‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">18‚Ç¨</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="px-3 py-4 whitespace-nowrap font-bold text-indigo-700 sticky left-0 bg-gray-50 z-10">Zona 2</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">20‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">25‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">30‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">10‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">12‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">15‚Ç¨</td>
                                </tr>
                                 <tr>
                                    <td class="px-3 py-4 whitespace-nowrap font-bold text-indigo-700 sticky left-0 bg-white z-10">Zona 3</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">15‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">20‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">25‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center border-l">8‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">10‚Ç¨</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-gray-700 text-center">12‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Leyenda de Zonas</h3>
                        <div class="space-y-3 text-sm text-gray-700 bg-gray-50 p-4 rounded-lg">
                            <p><strong>Zona 1 (M√°ximo Incentivo):</strong> Centro Madrid, Arganzuela, Retiro, Salamanca, Chamber√≠, Chamart√≠n.</p>
                            <p><strong>Zona 2 (Incentivo Medio):</strong> Usera, Moratalaz, Carabanchel, Ciudad Lineal, Tetu√°n, Fuencarral-ElPardo, San Blas-Canillejas, Villa de Vallecas, Barajas.</p>
                            <p><strong>Zona 3 (Incentivo B√°sico):</strong> Moncloa-Aravaca, Latina, Puente de Vallecas, Hortaleza, Villaverde, Vic√°lvaro, Resto de la Comunidad de Madrid.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Pisos (NUEVA ESTRUCTURA REDIMENSIONABLE) --><div id="pisos-content" class="tab-content">
                <!-- Contenedor con layout flex en desktop, y grid apilado en m√≥vil --><div id="pisos-resizable-container" class="grid grid-cols-1 gap-6 md:gap-0 min-h-full">
                    
                    <!-- Subida Pisos (Panel Izquierdo) --><div id="subida-pisos-panel" class="card p-4 flex flex-col resizable-panel md:mr-3 min-h-full">
                        <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2 border-b pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Subida Pisos (Excel)</h2>
                        <div class="iframe-container flex-grow w-full">
                            <iframe id="subida-pisos-iframe" class="w-full h-full rounded-lg border border-gray-200" title="Subida Pisos" loading="lazy" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>
                    
                    <!-- Divisor para Pisos (Solo visible y funcional en desktop) --><div id="pisos-resizer" class="hidden md:block"></div> 

                    <!-- Fotos Pisos (Panel Derecho) --><div id="fotos-pisos-panel" class="card p-4 flex flex-col resizable-panel md:ml-3 min-h-full">
                         <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center gap-2 border-b pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>Fotos Pisos (Drive)</h2>
                         <div class="iframe-container flex-grow w-full">
                            <iframe id="fotos-pisos-iframe" class="w-full h-full rounded-lg border border-gray-200" title="Fotos Pisos" loading="lazy" frameborder="0" allowfullscreen></iframe>
                         </div>
                    </div>
                </div>
            </div>
            
            <!-- (NUEVO) Contenido Pesta√±a: Generador de Certificado --><div id="certificado-content" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto w-full">
                    
                    <!-- (NUEVO) Calculadora de Precios -->
                    <div class="mb-8 border-b border-gray-200 pb-8">
                        <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M19 5H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/><path d="M7 15h0"/><path d="M7 11h0"/><path d="M10 15h0"/><path d="M10 11h0"/><path d="M13 15h0"/><path d="M13 11h0"/><path d="M16 15h0"/><path d="M16 11h0"/></svg>
                            Calculadora de Precios de Garant√≠a
                        </h2>
                        <p class="mb-6 text-gray-600 text-sm">Calcula el coste de la garant√≠a basado en el alquiler mensual y qui√©n contrata. El precio es un porcentaje de la anualidad.</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="precio-alquiler-mensual" class="block text-sm font-medium text-gray-700 mb-1">Alquiler Mensual (‚Ç¨)</label>
                                <input type="number" id="precio-alquiler-mensual" name="precio-alquiler-mensual" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: 850">
                            </div>
                            <div>
                                <label for="tipo-contratante" class="block text-sm font-medium text-gray-700 mb-1">Contratado por</label>
                                <select id="tipo-contratante" name="tipo-contratante" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="propietario">Propietario</option>
                                    <option value="inquilino">Inquilino 10</option>
                                    <option value="profesional_20">Profesional (-20%)</option>
                                    <option value="profesional_15">Profesional (-15%)</option>
                                </select>
                            </div>
                            <div>
                                <label for="tipo-inmueble" class="block text-sm font-medium text-gray-700 mb-1">Tipo de Inmueble</label>
                                <select id="tipo-inmueble" name="tipo-inmueble" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="vivienda">Vivienda</option>
                                    <option value="habitacion">Habitaci√≥n</option>
                                    <option value="comercial">Comercial</option>
                                </select>
                            </div>
                        </div>

                        <button id="calculate-price-button" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            Calcular Precio
                        </button>

                        <div id="precio-resultado-container" class="mt-6" style="display: none;">
                            <div class="calculator-result">
                                <span class="block text-sm font-medium text-gray-600 mb-1">Precio Final de la Garant√≠a (Pago √önico)</span>
                                <div id="precio-resultado" class="calculator-result-price">
                                    --- ‚Ç¨
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fin de la Calculadora de Precios -->


                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="m10.5 17-2-2 2-2"/><path d="m13.5 17 2-2-2-2"/></svg>
                        Generador de Certificado de Aprobaci√≥n
                    </h2>
                    <p class="mb-6 text-gray-600 text-sm">Utiliza la calculadora de arriba para fijar el precio. Luego, sube la captura de pantalla de la solicitud 'Aprobada' del SAI. El certificado se generar√° autom√°ticamente abajo (incluyendo el precio) listo para imprimir o guardar como PDF.</p>
                    
                    <!-- √Årea de Carga de Archivo --><div class="file-upload-wrapper w-full mb-6">
                        <input type="file" id="screenshot-upload" accept="image/*" />
                        <div class="file-upload-button text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            <span class="font-semibold text-indigo-600">Haz clic para subir una imagen</span>
                            <p class="text-xs text-gray-500 mt-1">o arrastra y suelta (PNG, JPG)</p>
                        </div>
                    </div>

                    <!-- Bot√≥n de Imprimir/Guardar --><div class="text-center mb-6">
                        <button id="print-certificate-button" class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-200" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                            Imprimir / Guardar como PDF
                        </button>
                        <p id="upload-hint" class="text-sm text-gray-500 mt-2">Sube una imagen para activar el bot√≥n de impresi√≥n.</p>
                    </div>

                    <!-- √Årea de Vista Previa del Certificado --><h3 class="text-xl font-bold text-gray-800 mb-4 border-t pt-6">Vista Previa del Certificado</h3>
                    <div id="certificate-preview" class="bg-gray-100 p-4 rounded-lg">
                        <!-- El certificado generado por JS aparecer√° aqu√≠ --></div>
                </div>
            </div>

            <!-- Contenido Pesta√±a: Spotify --><div id="spotify-content" class="tab-content">
                <div class="card p-6 max-w-4xl mx-auto w-full">
                     <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>Spotify Player (Focus Music)</h2>
                    
                    <button onclick="window.open(SPOTIFY_WEB_URL, '_blank')" class="w-full mb-6 px-6 py-3 text-lg font-bold rounded-lg shadow-md text-white bg-green-500 hover:bg-green-600 transition duration-200 external-link-button">
                        Abrir Spotify Web Player üéß
                    </button>

                    <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator" width="100%" height="450" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                </div>
            </div>

            <!-- Contenido Pesta√±a: To-Do List --><div id="todo-content" class="tab-content">
                <div class="card p-6 max-w-xl mx-auto w-full">
                    <h2 class="text-2xl font-extrabold text-gray-800 mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        Lista de Tareas (Focus)
                    </h2>
                    <p class="mb-4 text-gray-600 text-sm">Mantente enfocado en tus tareas diarias y acciones de seguimiento.</p>
                    <div class="flex mb-6">
                        <input type="text" id="todo-input" class="w-full p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="A√±adir nueva tarea, Ej: Llamar a Juan (√âlite)">
                        <button id="add-todo-button" class="px-3 sm:px-6 py-3 bg-indigo-600 text-white font-semibold rounded-r-lg shadow-md hover:bg-indigo-700 transition duration-200 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    </div>
                    <div id="todo-list" class="space-y-3">
                        <!-- Las tareas se generar√°n aqu√≠ --></div>
                </div>
            </div>
        </main>
    </div>

</body>
</html>